package chimhaha.chimcard.card;

import chimhaha.chimcard.card.repository.AccountCardRepository;
import chimhaha.chimcard.card.repository.CardCustomRepository;
import chimhaha.chimcard.card.repository.CardRepository;
import chimhaha.chimcard.card.repository.CardSeasonRepository;
import chimhaha.chimcard.config.P6SpyConfig;
import chimhaha.chimcard.config.QueryDslConfig;
import chimhaha.chimcard.entity.*;
import chimhaha.chimcard.exception.ResourceNotFoundException;
import chimhaha.chimcard.user.repository.AccountRepository;
import chimhaha.chimcard.utils.CardUtils;
import com.querydsl.jpa.impl.JPAQueryFactory;
import jakarta.persistence.EntityManager;
import jakarta.transaction.Transactional;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.RepeatedTest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.context.annotation.Import;

import java.util.*;
import java.util.stream.Collectors;

import static chimhaha.chimcard.entity.QAccountCard.accountCard;

@Slf4j
@DataJpaTest
@Import({QueryDslConfig.class, P6SpyConfig.class})
public class CardPackOpenTest {

    @Autowired CardSeasonRepository cardSeasonRepository;
    @Autowired CardRepository cardRepository;
    @Autowired AccountRepository accountRepository;
    @Autowired AccountCardRepository accountCardRepository;
    @Autowired JPAQueryFactory query;

    @RepeatedTest(5)
    @Transactional
    void cardPackOpen() throws Exception {
        //given
        List<Card> drawnCards = new ArrayList<>();
        Random random = new Random();

        CardSeason cardSeason = cardSeasonRepository.findById(2L)
                .orElseThrow(() -> new IllegalArgumentException("해당 시즌 카드팩은 존재하지 않습니다."));

        Account account = accountRepository.findById(1L)
                .orElseThrow(() -> new ResourceNotFoundException("해당 회원을 찾을 수 없습니다."));

        //when
        // 1. 해당 시즌의 모든 카드를 등급별로 분류
        Map<Grade, List<Card>> map = cardRepository.findByCardSeason(cardSeason)
                .stream().collect(Collectors.groupingBy(Card::getGrade));

        //then
        // 2. 3장의 카드를 뽑음
        for (int i = 0; i < 3; i++) {
            Card drawnCard = drawCardBySeason(map, random, cardSeason.getId());
            drawnCards.add(drawnCard);
        }

        // 뽑은 카드 중 중복 처리
        Map<Card, Long> drawnCardMap = CardUtils.cardCountMap(drawnCards);
        upsertList(account, drawnCardMap);

        log.info(drawnCards.toString());
    }

    private void upsertList(Account account, Map<Card, Long> cardMap) {
        List<AccountCard> accountCards = getMyCardByCards(account, cardMap.keySet());
        Map<Card, AccountCard> accountCardMap = CardUtils.accountCardMapCard(accountCards);

        List<AccountCard> upsertCards = new ArrayList<>();
        for (Map.Entry<Card, Long> entry : cardMap.entrySet()) {
            Card card = entry.getKey();
            Long count = entry.getValue();

            AccountCard accountCard = accountCardMap.get(card);
            if (accountCard == null) {
                accountCard = new AccountCard(account, card, count);
            } else {
                accountCard.increaseCount(count);
            }

            upsertCards.add(accountCard);
        }

        accountCardRepository.saveAll(upsertCards);
    }

    private List<AccountCard> getMyCardByCards(Account account, Set<Card> cards) {
        return query
                .selectFrom(accountCard)
                .where(
                        accountCard.account().eq(account),
                        accountCard.card().in(cards)
                )
                .fetch();
    }


    private Card drawCardBySeason(Map<Grade, List<Card>> map, Random random, Long seasonId) {
        if (seasonId == 1) {
            int randomValue = random.nextInt(100);
            return drawCardSeason1(map, randomValue);
        } else if (seasonId == 2) {
            int randomValue = random.nextInt(10000);
            return drawCardSeason2(map, randomValue);
        } else {
            throw new IllegalArgumentException("해당 시즌 카드팩은 존재하지 않습니다.");
        }
    }

    private Card drawCardSeason1(Map<Grade, List<Card>> map, int randomValue) {
        if (randomValue < 1) { //1% (0)
            return getRandomCardByGrade(map, Grade.SSR);
        } else if (randomValue < 11) { //10% (1 ~ 10)
            return getRandomCardByGrade(map, Grade.SR);
        } else if (randomValue < 45) { // 34% (11 ~ 44)
            return getRandomCardByGrade(map, Grade.R);
        } else { // 55% (45 ~ 99)
            return getRandomCardByGrade(map, Grade.N);
        }
    }

    private Card drawCardSeason2(Map<Grade, List<Card>> map, int randomValue) {
        if (randomValue < 32) { // 0.32%
            return getRandomCardByGrade(map, Grade.SSR);
        } else if (randomValue < 432) { // 4%
            return getRandomCardByGrade(map, Grade.SR);
        } else if (randomValue < 2232) { // 18%
            return getRandomCardByGrade(map, Grade.R);
        } else if (randomValue < 6900) { // 46.68%
            return getRandomCardByGrade(map, Grade.N);
        } else if (randomValue < 9900) { // 30%
            return getRandomCardByGrade(map, Grade.C);
        } else { // 1%
            return getRandomCardByGrade(map, Grade.V);
        }
    }

    private Card getRandomCardByGrade(Map<Grade, List<Card>> map, Grade grade) {
        List<Card> cards = map.get(grade);

        return cards.get(new Random().nextInt(cards.size()));
    }
}
